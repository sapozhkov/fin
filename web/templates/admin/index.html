{% extends 'admin/master.html' %}

{% block body %}
    <div class="container mt-4">
        <div id="run-table-container">
            {% include 'admin/run_table.html' %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function fetchRuns() {
                if (document.visibilityState !== 'visible')
                    return;

                fetch('{{ url_for('admin.get_runs') }}')
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('run-table-container').innerHTML = html;
                    })
                    .catch(error => console.error('Error fetching runs:', error));
            }

            // Fetch runs every 30 seconds
            setInterval(fetchRuns, 30000);

            // Initial fetch
            fetchRuns();

            // Check if the document's visibility state is 'visible' and send a request for updates
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    fetchRuns();
                }
            });
        });
    </script>

        <script>
      (function() {
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è cookie –ø–æ –∏–º–µ–Ω–∏
        function getCookie(name) {
          let matches = document.cookie.match(new RegExp(
            "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
          ));
          return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ cookie
        function setCookie(name, value, options = {}) {
          options = {
            path: '/',
            // –£—Å—Ç–∞–Ω–æ–≤–∏–º —Å—Ä–æ–∫ –∂–∏–∑–Ω–∏ –Ω–∞ –≥–æ–¥
            'max-age': 31536000,
            ...options
          };

          if (options.expires instanceof Date) {
            options.expires = options.expires.toUTCString();
          }

          let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

          for (let optionKey in options) {
            updatedCookie += "; " + optionKey;
            let optionValue = options[optionKey];
            if (optionValue !== true) {
              updatedCookie += "=" + optionValue;
            }
          }

          document.cookie = updatedCookie;
        }

        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º localStorage
        let storedTheme = localStorage.getItem('theme');

        // 2. –ï—Å–ª–∏ –≤ localStorage –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        let preferredTheme = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';

        // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Ç–µ–º—É: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É localStorage
        let currentTheme = storedTheme || preferredTheme;

        // 4. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ cookie
        let themeCookie = getCookie('user_theme');

        // 5. –ï—Å–ª–∏ cookie –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏–ª–∏ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º–µ,
        //    —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º cookie –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —Å–µ—Ä–≤–µ—Ä –æ—Ç–¥–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π CSS
        if (themeCookie !== currentTheme) {
          console.log(`Theme mismatch or cookie not set. Setting 'user_theme' cookie to '${currentTheme}' and reloading.`);
          setCookie('user_theme', currentTheme);
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å –Ω–∞ body –î–û –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∏–≥–∞–Ω–∏–µ
          document.documentElement.setAttribute('data-bs-theme', currentTheme); // –î–ª—è Bootstrap 5+ –º–æ–∂–Ω–æ —Ç–∞–∫ —Å—Ç–∏–ª–∏–∑–æ–≤–∞—Ç—å
          if (currentTheme === 'dark') {
             document.body.classList.add('theme-dark'); // –ò–ª–∏ —Å–≤–æ–π –∫–ª–∞—Å—Å
          } else {
             document.body.classList.remove('theme-dark');
          }
          // –î–∞–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π, —á—Ç–æ–±—ã cookie —É—Å–ø–µ–ª —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è
          setTimeout(() => {
             location.reload();
          }, 50); // 50 –º—Å –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
        } else {
           // Cookie —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π, –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–ª–∞—Å—Å—ã –¥–ª—è –≤–æ–∑–º–æ–∂–Ω—ã—Ö —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–π —á–µ—Ä–µ–∑ JS/CSS
           document.documentElement.setAttribute('data-bs-theme', currentTheme); // –î–ª—è Bootstrap 5+
           if (currentTheme === 'dark') {
               document.body.classList.add('theme-dark');
            } else {
               document.body.classList.remove('theme-dark');
            }
        }

        // --- –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è ---
        // –≠—Ç—É —á–∞—Å—Ç—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞
        /*
        // –ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏—é (—Å–µ–ª–µ–∫—Ç–æ—Ä –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è)
        const navbar = document.querySelector('.navbar .nav, .navbar-nav'); // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—É—é –ø–∞–Ω–µ–ª—å
        if (navbar) {
            const themeToggleLi = document.createElement('li');
            themeToggleLi.style.marginLeft = 'auto'; // –°–¥–≤–∏–≥–∞–µ–º –≤–ø—Ä–∞–≤–æ
            const themeToggleButton = document.createElement('button');
            themeToggleButton.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
            themeToggleButton.classList.add('btn', 'btn-sm', 'btn-outline-secondary', 'ms-2'); // –°—Ç–∏–ª–∏ Bootstrap
            themeToggleButton.style.marginTop = '8px'; // –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è

            themeToggleButton.onclick = function() {
                let newTheme = (localStorage.getItem('theme') || preferredTheme) === 'dark' ? 'light' : 'dark';
                localStorage.setItem('theme', newTheme); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
                setCookie('user_theme', newTheme);      // –û–±–Ω–æ–≤–ª—è–µ–º cookie
                location.reload();                      // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            };
            themeToggleLi.appendChild(themeToggleButton);
            navbar.appendChild(themeToggleLi); // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤ navbar
        }
        */

      })();
    </script>
{% endblock %}
